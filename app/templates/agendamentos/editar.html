{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('listar_pacientes') }}">Pacientes</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('detalhe_paciente', paciente_id=paciente.id) }}">{{ paciente.nome }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">Editar Agendamento</li>
            </ol>
        </nav>
        <h1 class="h2">
            <i class="bi bi-calendar-check"></i> Editar Agendamento
        </h1>
        <p class="text-muted">Paciente: {{ paciente.nome }}</p>
    </div>
    <a href="{{ url_for('listar_agendamentos', data=agendamento.data_consulta) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <form method="POST" action="{{ url_for('editar_agendamento', agendamento_id=agendamento.id) }}">
            {{ form.hidden_tag() }}
            {{ form.paciente_id(value=paciente.id) }}
            
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="data_consulta" class="form-label">Data da Consulta*</label>
                    {{ form.data_consulta(class="form-control " + ("is-invalid" if form.data_consulta.errors else ""), id="data_consulta", type="date") }}
                    {% if form.data_consulta.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.data_consulta.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="hora_consulta" class="form-label">Hora da Consulta*</label>
                    {{ form.hora_consulta(class="form-control " + ("is-invalid" if form.hora_consulta.errors else ""), id="hora_consulta", placeholder="Ex: 14:30") }}
                    {% if form.hora_consulta.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.hora_consulta.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="tipo_consulta" class="form-label">Tipo de Consulta*</label>
                    {{ form.tipo_consulta(class="form-control " + ("is-invalid" if form.tipo_consulta.errors else ""), id="tipo_consulta", placeholder="Ex: Avaliação, Limpeza, etc.") }}
                    {% if form.tipo_consulta.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.tipo_consulta.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="status" class="form-label">Status</label>
                    {{ form.status(class="form-select " + ("is-invalid" if form.status.errors else ""), id="status") }}
                    {% if form.status.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.status.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-12">
                    <label for="observacao" class="form-label">Observação</label>
                    {{ form.observacao(class="form-control " + ("is-invalid" if form.observacao.errors else ""), id="observacao", rows=3) }}
                    {% if form.observacao.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.observacao.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-12 mt-3">
                    <div class="d-flex justify-content-end">
                        <a href="{{ url_for('listar_agendamentos', data=agendamento.data_consulta) }}" class="btn btn-outline-secondary me-2">Cancelar</a>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Time input mask
    document.getElementById('hora_consulta').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length > 4) value = value.slice(0, 4);
        
        if (value.length > 2) {
            // Make sure hour is valid (00-23)
            let hour = parseInt(value.substring(0, 2));
            if (hour > 23) hour = 23;
            
            // Make sure minute is valid (00-59)
            let minute = parseInt(value.substring(2));
            if (minute > 59) minute = 59;
            
            value = hour.toString().padStart(2, '0') + ':' + minute.toString().padStart(2, '0');
        } else if (value.length > 0) {
            value = value.padStart(2, '0') + ':';
        }
        
        e.target.value = value;
    });
    
    // Provide some common procedure types as suggestions
    const tipoConsultas = [
        "Avaliação Inicial", 
        "Consulta de Rotina", 
        "Limpeza", 
        "Restauração", 
        "Extração", 
        "Tratamento de Canal",
        "Clareamento",
        "Profilaxia",
        "Radiografia",
        "Ajuste de Aparelho",
        "Cirurgia"
    ];
    
    const datalist = document.createElement('datalist');
    datalist.id = 'tipoConsultasList';
    
    tipoConsultas.forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo;
        datalist.appendChild(option);
    });
    
    document.body.appendChild(datalist);
    document.getElementById('tipo_consulta').setAttribute('list', 'tipoConsultasList');
</script>
{% endblock %}
