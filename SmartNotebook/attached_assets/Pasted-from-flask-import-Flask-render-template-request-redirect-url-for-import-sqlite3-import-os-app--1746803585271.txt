from flask import Flask, render_template, request, redirect, url_for
import sqlite3
import os

app = Flask(__name__)

# Banco de dados
DB_NAME = "pacientes.db"

def get_db():
    conn = sqlite3.connect(DB_NAME)
    conn.row_factory = sqlite3.Row
    return conn

# Rota principal
@app.route('/')
def index():
    conn = get_db()
    pacientes = conn.execute("SELECT * FROM pacientes").fetchall()
    conn.close()
    return render_template('index.html', pacientes=pacientes)

# Rota para cadastrar paciente
@app.route('/cadastro', methods=['GET', 'POST'])
def cadastro():
    if request.method == 'POST':
        nome = request.form['nome']
        nascimento = request.form['nascimento']
        telefone = request.form['telefone']
        endereco = request.form['endereco']
        cpf = request.form['cpf']
        genero = request.form['genero']
        doencas = request.form['doencas']
        medicamentos = request.form['medicamentos']
        alergias = request.form['alergias']
        cirurgias = request.form['cirurgias']
        habitos = request.form['habitos']
        observacoes = request.form['observacoes']
        
        conn = get_db()
        conn.execute('''
            INSERT INTO pacientes (nome, nascimento, telefone, endereco, cpf, genero, doencas, medicamentos, alergias, cirurgias, habitos, observacoes)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (nome, nascimento, telefone, endereco, cpf, genero, doencas, medicamentos, alergias, cirurgias, habitos, observacoes))
        conn.commit()
        conn.close()
        return redirect(url_for('index'))
    return render_template('cadastro.html')

# Rota para visualizar um paciente
@app.route('/paciente/<int:id>', methods=['GET', 'POST'])
def paciente(id):
    conn = get_db()
    paciente = conn.execute("SELECT * FROM pacientes WHERE id = ?", (id,)).fetchone()
    evolucoes = conn.execute("SELECT * FROM evolucoes WHERE paciente_id = ?", (id,)).fetchall()
    radios = conn.execute("SELECT * FROM radiografias WHERE paciente_id = ?", (id,)).fetchall()
    conn.close()
    return render_template('paciente.html', paciente=paciente, evolucoes=evolucoes, radios=radios)

# Rota para adicionar evolução ao paciente
@app.route('/evolucao/<int:id>', methods=['POST'])
def evolucao(id):
    data = request.form['data']
    procedimento = request.form['procedimento']
    supervisor = request.form['supervisor']
    observacao = request.form['observacao']
    detalhes = request.form['detalhes']
    
    conn = get_db()
    conn.execute('''
        INSERT INTO evolucoes (paciente_id, data, procedimento, supervisor, observacao, detalhes)
        VALUES (?, ?, ?, ?, ?, ?)
    ''', (id, data, procedimento, supervisor, observacao, detalhes))
    conn.commit()
    conn.close()
    return redirect(url_for('paciente', id=id))

# Rota para detalhes da consulta
@app.route('/consulta/<int:evolucao_id>')
def consulta(evolucao_id):
    conn = get_db()
    evolucao = conn.execute("SELECT * FROM evolucoes WHERE id = ?", (evolucao_id,)).fetchone()
    conn.close()
    return render_template('consulta.html', consulta=evolucao)

# Rota para upload de radiografia
@app.route('/upload_radiografia/<int:id>', methods=['POST'])
def upload_radiografia(id):
    arquivo = request.files['radiografia']
    if arquivo:
        filename = arquivo.filename
        file_path = os.path.join('static', 'radiografias', filename)
        arquivo.save(file_path)

        conn = get_db()
        conn.execute('''
            INSERT INTO radiografias (paciente_id, nome_arquivo)
            VALUES (?, ?)
        ''', (id, filename))
        conn.commit()
        conn.close()
    return redirect(url_for('paciente', id=id))

if __name__ == '__main__':
    app.run(debug=True)
